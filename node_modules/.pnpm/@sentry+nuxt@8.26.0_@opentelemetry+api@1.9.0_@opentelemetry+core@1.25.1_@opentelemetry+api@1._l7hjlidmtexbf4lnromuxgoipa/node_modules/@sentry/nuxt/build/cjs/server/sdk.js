var {
  _nullishCoalesce,
  _optionalChain
} = require('@sentry/utils');

Object.defineProperty(exports, '__esModule', { value: true });

const core = require('@sentry/core');
const node = require('@sentry/node');
const utils = require('@sentry/utils');
const debugBuild = require('../common/debug-build.js');

/**
 * Initializes the server-side of the Nuxt SDK
 *
 * @param options Configuration options for the SDK.
 */
function init(options) {
  const sentryOptions = {
    ...options,
    registerEsmLoaderHooks: mergeRegisterEsmLoaderHooks(options),
  };

  core.applySdkMetadata(sentryOptions, 'nuxt', ['nuxt', 'node']);

  const client = node.init(sentryOptions);

  core.getGlobalScope().addEventProcessor(
    Object.assign(
      (event => {
        if (event.type === 'transaction') {
          // Filter out transactions for Nuxt build assets
          // This regex matches the default path to the nuxt-generated build assets (`_nuxt`).
          // todo: the buildAssetDir could be changed in the nuxt config - change this to a more generic solution
          if (_optionalChain([event, 'access', _ => _.transaction, 'optionalAccess', _2 => _2.match, 'call', _3 => _3(/^GET \/_nuxt\//)])) {
            options.debug &&
              debugBuild.DEBUG_BUILD &&
              utils.logger.log('NuxtLowQualityTransactionsFilter filtered transaction: ', event.transaction);
            return null;
          }

          return event;
        } else {
          return event;
        }
      }) ,
      { id: 'NuxtLowQualityTransactionsFilter' },
    ),
  );

  return client;
}

/**
 * Adds /vue/ to the registerEsmLoaderHooks options and merges it with the old values in the array if one is defined.
 * If the registerEsmLoaderHooks option is already a boolean, nothing is changed.
 *
 * Only exported for Testing purposes.
 */
function mergeRegisterEsmLoaderHooks(
  options,
) {
  if (typeof options.registerEsmLoaderHooks === 'object' && options.registerEsmLoaderHooks !== null) {
    return {
      exclude: Array.isArray(options.registerEsmLoaderHooks.exclude)
        ? [...options.registerEsmLoaderHooks.exclude, /vue/]
        : _nullishCoalesce(options.registerEsmLoaderHooks.exclude, () => ( [/vue/])),
    };
  }
  return _nullishCoalesce(options.registerEsmLoaderHooks, () => ( { exclude: [/vue/] }));
}

exports.init = init;
exports.mergeRegisterEsmLoaderHooks = mergeRegisterEsmLoaderHooks;
//# sourceMappingURL=sdk.js.map
